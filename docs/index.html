<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Opportunities Hub - Find Your Next Exhibition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DM Sans', sans-serif; }
        .serif { font-family: 'DM Serif Display', serif; }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -15px rgba(0,0,0,0.2);
        }
        .deadline-soon {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .tag {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-pink-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-purple-100 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">
                        <span class="gradient-text">Artist Hub</span>
                    </h1>
                    <div class="hidden sm:flex items-center space-x-2 text-sm text-gray-600">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="liveCount">Loading opportunities...</span>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="flex items-center space-x-6">
                    <div class="hidden md:flex items-center space-x-6 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="totalOpps">0</div>
                            <div class="text-xs text-gray-500">Total</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-500" id="thisWeek">0</div>
                            <div class="text-xs text-gray-500">This Week</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="freeOpps">0</div>
                            <div class="text-xs text-gray-500">Free</div>
                        </div>
                    </div>
                    <button onclick="showConfig()" class="p-2 rounded-lg hover:bg-purple-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filters Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Find Your Perfect Opportunity</h2>
                <button onclick="resetFilters()" class="text-sm text-purple-600 hover:text-purple-800 transition-colors">
                    Reset Filters
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Search -->
                <div class="md:col-span-2">
                    <input type="text" id="searchInput" placeholder="Search title, organization, or location..." 
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           onkeyup="applyFilters()">
                </div>
                
                <!-- Platform Filter -->
                <select id="platformFilter" onchange="applyFilters()" 
                        class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <option value="">All Platforms</option>
                    <option value="cafe">üé® CAFE</option>
                    <option value="artcall">üñºÔ∏è ArtCall</option>
                    <option value="showsubmit">üìã ShowSubmit</option>
                    <option value="artwork_archive">üìö Artwork Archive</option>
                    <option value="zapplication">‚ö° Zapplication</option>
                </select>
                
                <!-- Type Filter -->
                <select id="typeFilter" onchange="applyFilters()" 
                        class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <option value="">All Types</option>
                    <option value="fair">Art Fair</option>
                    <option value="exhibition">Exhibition</option>
                    <option value="competition">Competition</option>
                    <option value="residency">Residency</option>
                    <option value="grant">Grant</option>
                    <option value="public art">Public Art</option>
                </select>
                
                <!-- Fee Filter -->
                <select id="feeFilter" onchange="applyFilters()" 
                        class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <option value="">Any Fee</option>
                    <option value="free">Free</option>
                    <option value="under50">Under $50</option>
                    <option value="under100">Under $100</option>
                    <option value="over100">$100+</option>
                </select>
            </div>
            
            <!-- Quick Filters -->
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="filterDeadline('week')" class="tag bg-orange-100 text-orange-800 hover:bg-orange-200 cursor-pointer">
                    üìÖ Closing This Week
                </button>
                <button onclick="filterDeadline('month')" class="tag bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer">
                    üìÜ Closing This Month
                </button>
                <button onclick="filterLocation('online')" class="tag bg-green-100 text-green-800 hover:bg-green-200 cursor-pointer">
                    üåê Online Only
                </button>
            </div>
        </div>

        <!-- Results Count -->
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-medium text-gray-700">
                <span id="resultsCount">0</span> Opportunities Found
            </h3>
            <select id="sortBy" onchange="applyFilters()" 
                    class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="deadline">Deadline (Soonest First)</option>
                <option value="newest">Newest First</option>
                <option value="fee_low">Fee (Low to High)</option>
                <option value="fee_high">Fee (High to Low)</option>
            </select>
        </div>

        <!-- Opportunities Grid -->
        <div id="opportunitiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards will be inserted here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Loading cards -->
                <div class="bg-white rounded-xl p-6 loading-shimmer h-64"></div>
                <div class="bg-white rounded-xl p-6 loading-shimmer h-64"></div>
                <div class="bg-white rounded-xl p-6 loading-shimmer h-64"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="text-6xl mb-4">üé®</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">No opportunities found</h3>
            <p class="text-gray-600">Try adjusting your filters or check back later for new opportunities.</p>
        </div>
    </main>

    <!-- Configuration Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-6">Connect to Database</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
                    <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Anon Key</label>
                    <input type="password" id="supabaseKey" placeholder="Your anonymous key..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <button onclick="connectDatabase()" 
                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                    Connect
                </button>
                <button onclick="closeConfig()" 
                        class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div id="modalContent" class="overflow-y-auto max-h-[90vh]">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let supabase = null;
        let opportunities = [];
        let filteredOpportunities = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkConnection();
        });

        function checkConnection() {
            let url = localStorage.getItem('supabaseUrl');
            let key = localStorage.getItem('supabaseKey');
            
            // Auto-configure with default values if not set
            if (!url || !key) {
                url = 'https://hqevaaiketyqhzajqfwj.supabase.co';
                key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxZXZhYWlrZXR5cWh6YWpxZndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjk1NTUsImV4cCI6MjA3MTkwNTU1NX0.hTlqdVtgmbarPGmFNGPBjG73rrq9f1fniAJ78aXHGYA';
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
            }
            
            if (url && key) {
                supabase = window.supabase.createClient(url, key);
                loadOpportunities();
            } else {
                showConfig();
            }
        }

        function showConfig() {
            document.getElementById('configModal').classList.remove('hidden');
            document.getElementById('supabaseUrl').value = localStorage.getItem('supabaseUrl') || '';
            document.getElementById('supabaseKey').value = localStorage.getItem('supabaseKey') || '';
        }

        function closeConfig() {
            document.getElementById('configModal').classList.add('hidden');
        }

        function connectDatabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                alert('Please enter both URL and key');
                return;
            }
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            supabase = window.supabase.createClient(url, key);
            closeConfig();
            loadOpportunities();
        }

        async function loadOpportunities() {
            showLoading();
            
            try {
                // Query opportunities_v2 table with new schema
                const { data, error } = await supabase
                    .from('opportunities_v2')
                    .select('*')
                    .eq('is_active', true)
                    .order('deadline', { ascending: true });
                
                if (error) throw error;
                
                opportunities = data || [];
                filteredOpportunities = [...opportunities];
                
                updateStats();
                renderOpportunities();
                
            } catch (error) {
                console.error('Error loading opportunities:', error);
                // Try fallback to old table
                try {
                    const { data, error } = await supabase
                        .from('opportunities')
                        .select('*')
                        .order('deadline', { ascending: true });
                    
                    if (!error && data) {
                        opportunities = data || [];
                        filteredOpportunities = [...opportunities];
                        updateStats();
                        renderOpportunities();
                    } else {
                        showEmpty();
                    }
                } catch (fallbackError) {
                    showEmpty();
                }
            }
        }

        function updateStats() {
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('totalOpps').textContent = opportunities.length;
            document.getElementById('liveCount').textContent = `${opportunities.length} opportunities available`;
            
            const thisWeek = opportunities.filter(o => {
                const deadline = new Date(o.deadline);
                return deadline <= weekFromNow && deadline >= now;
            }).length;
            document.getElementById('thisWeek').textContent = thisWeek;
            
            const free = opportunities.filter(o => 
                !o.application_fee || o.application_fee === 0 || o.application_fee === '0'
            ).length;
            document.getElementById('freeOpps').textContent = free;
            
            document.getElementById('resultsCount').textContent = filteredOpportunities.length;
        }

        function renderOpportunities() {
            const grid = document.getElementById('opportunitiesGrid');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            
            loadingState.classList.add('hidden');
            
            if (filteredOpportunities.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = filteredOpportunities.map(opp => createCard(opp)).join('');
        }

        function createCard(opp) {
            const deadline = opp.deadline ? new Date(opp.deadline) : null;
            const now = new Date();
            const daysUntil = deadline ? Math.ceil((deadline - now) / (1000 * 60 * 60 * 24)) : null;
            
            const urgentClass = daysUntil && daysUntil <= 7 ? 'deadline-soon' : '';
            const deadlineColor = daysUntil && daysUntil <= 7 ? 'text-red-600' : 'text-gray-600';
            
            const fee = opp.application_fee ? 
                (typeof opp.application_fee === 'number' ? `$${opp.application_fee}` : opp.application_fee) : 
                'Free';
            
            const feeColor = fee === 'Free' ? 'text-green-600' : 'text-gray-600';
            
            const location = [opp.location_city, opp.location_state, opp.location_country]
                .filter(Boolean)
                .join(', ') || 'Location TBD';
            
            const typeLabel = opp.opportunity_type ? 
                opp.opportunity_type.charAt(0).toUpperCase() + opp.opportunity_type.slice(1) : 
                'Opportunity';
            
            const typeColors = {
                'fair': 'bg-blue-100 text-blue-800',
                'exhibition': 'bg-purple-100 text-purple-800',
                'competition': 'bg-orange-100 text-orange-800',
                'residency': 'bg-green-100 text-green-800',
                'grant': 'bg-yellow-100 text-yellow-800',
                'public art': 'bg-pink-100 text-pink-800',
                'other': 'bg-gray-100 text-gray-800'
            };
            
            const platformColors = {
                'zapplication': 'üé™',
                'cafe': '‚òï',
                'showsubmit': 'üé®',
                'artwork_archive': 'üñºÔ∏è',
                'artcall': 'üì¢',
                'other': 'üìå'
            };
            
            const typeColor = typeColors[opp.opportunity_type] || typeColors['other'];
            
            return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden card-hover cursor-pointer h-full flex flex-col" 
                     onclick='showDetail(${JSON.stringify(opp).replace(/'/g, "&apos;")})'>
                    <div class="p-6 flex-grow flex flex-col">
                        <div class="flex items-start justify-between mb-3">
                            <span class="tag ${typeColor}">${typeLabel}</span>
                            ${daysUntil && daysUntil <= 7 ? 
                                `<span class="tag bg-red-100 text-red-800 ${urgentClass}">‚ö° ${daysUntil} days left</span>` : 
                                ''}
                        </div>
                        
                        <h3 class="font-bold text-lg text-gray-900 mb-2 line-clamp-2">
                            ${opp.title || 'Untitled Opportunity'}
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-4">
                            ${opp.organization || 'Organization TBD'}
                        </p>
                        
                        <div class="space-y-2 text-sm">
                            ${deadline ? `
                                <div class="flex items-center ${deadlineColor}">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                    ${daysUntil ? ` (${daysUntil} days)` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="flex items-center text-gray-600">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                ${location}
                            </div>
                            
                            <div class="flex items-center ${feeColor} font-medium">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Application: ${fee}
                            </div>
                        </div>
                        
                        ${opp.description && opp.description !== opp.title ? `
                            <p class="text-sm text-gray-500 mt-auto pt-4 line-clamp-2">
                                ${opp.description.replace(opp.title, '').substring(0, 150).trim()}${opp.description.length > 150 ? '...' : ''}
                            </p>
                        ` : ''}
                    </div>
                    
                    <div class="px-6 py-3 bg-gray-50 border-t border-gray-100 mt-auto">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500 flex items-center">
                                <span class="text-lg mr-1">${platformColors[opp.source_platform] || platformColors['other']}</span>
                                ${opp.source_platform ? opp.source_platform.replace('_', ' ') : 'Unknown'}
                            </span>
                            <span class="text-xs text-purple-600 font-medium">
                                View Details ‚Üí
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function showDetail(opp) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');
            
            // Add escape key listener
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closeDetail();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            const deadline = opp.deadline ? new Date(opp.deadline) : null;
            const fee = opp.application_fee ? 
                (typeof opp.application_fee === 'number' ? `$${opp.application_fee}` : opp.application_fee) : 
                'Free';
            
            const location = [opp.location_city, opp.location_state, opp.location_country]
                .filter(Boolean)
                .join(', ') || 'Location TBD';
            
            // Parse extras if it exists
            let extras = {};
            try {
                extras = opp.extras ? (typeof opp.extras === 'string' ? JSON.parse(opp.extras) : opp.extras) : {};
            } catch (e) {
                extras = {};
            }
            
            content.innerHTML = `
                <div class="relative">
                    <button onclick="closeDetail()" class="absolute top-4 right-4 p-2 bg-white rounded-full shadow-lg hover:shadow-xl transition-shadow z-10">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    
                    <div class="bg-gradient-to-br from-purple-600 to-pink-600 p-8 text-white">
                        <div class="max-w-3xl">
                            <h2 class="text-3xl font-bold mb-3">${opp.title || 'Untitled Opportunity'}</h2>
                            <p class="text-xl text-purple-100">${opp.organization || 'Organization TBD'}</p>
                        </div>
                    </div>
                    
                    <div class="p-8">
                        <div class="grid md:grid-cols-3 gap-8">
                            <!-- Key Details -->
                            <div class="md:col-span-2 space-y-6">
                                ${opp.description ? `
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-3">Description</h3>
                                        <p class="text-gray-600 whitespace-pre-wrap">${opp.description}</p>
                                    </div>
                                ` : ''}
                                
                                ${opp.eligibility_requirements ? `
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-3">Eligibility</h3>
                                        <p class="text-gray-600 whitespace-pre-wrap">${opp.eligibility_requirements}</p>
                                    </div>
                                ` : ''}
                                
                                ${opp.media_accepted ? `
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-3">Media Accepted</h3>
                                        <p class="text-gray-600">${opp.media_accepted}</p>
                                    </div>
                                ` : ''}
                                
                                ${opp.benefits_offered ? `
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-3">Benefits</h3>
                                        <p class="text-gray-600">${opp.benefits_offered}</p>
                                    </div>
                                ` : ''}
                                
                                ${Object.keys(extras).length > 0 ? `
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-3">Additional Information</h3>
                                        <div class="space-y-2">
                                            ${Object.entries(extras).map(([key, value]) => {
                                                // Skip if value is null, undefined, or an object
                                                if (value === null || value === undefined) return '';
                                                if (typeof value === 'object') {
                                                    // If it's an object with a 'value' property, use that
                                                    if (value.value !== undefined) {
                                                        value = value.value;
                                                    } else {
                                                        // Skip complex objects
                                                        return '';
                                                    }
                                                }
                                                // Only show if value is meaningful
                                                if (value === '' || value === 'null') return '';
                                                
                                                return `
                                                    <div class="flex">
                                                        <span class="font-medium text-gray-700 mr-2">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                                                        <span class="text-gray-600">${value}</span>
                                                    </div>
                                                `;
                                            }).filter(item => item !== '').join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Sidebar -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                                    <h3 class="font-semibold text-gray-900">Quick Facts</h3>
                                    
                                    ${deadline ? `
                                        <div>
                                            <div class="text-sm text-gray-500 mb-1">Deadline</div>
                                            <div class="font-medium text-gray-900">
                                                ${deadline.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div>
                                        <div class="text-sm text-gray-500 mb-1">Application Fee</div>
                                        <div class="font-medium text-gray-900">${fee}</div>
                                    </div>
                                    
                                    <div>
                                        <div class="text-sm text-gray-500 mb-1">Location</div>
                                        <div class="font-medium text-gray-900">${location}</div>
                                    </div>
                                    
                                    ${opp.notification_date ? `
                                        <div>
                                            <div class="text-sm text-gray-500 mb-1">Notification Date</div>
                                            <div class="font-medium text-gray-900">
                                                ${new Date(opp.notification_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${opp.event_dates ? `
                                        <div>
                                            <div class="text-sm text-gray-500 mb-1">Event Dates</div>
                                            <div class="font-medium text-gray-900">${opp.event_dates}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <a href="${opp.url}" target="_blank" rel="noopener noreferrer" 
                                   class="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-center py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                                    ${opp.source_platform === 'artwork_archive' || opp.source_platform === 'showsubmit' ? 
                                        'View Full Details ‚Üí' : 'Apply Now ‚Üí'}
                                </a>
                                
                                ${opp.source_platform === 'artwork_archive' || opp.source_platform === 'showsubmit' ? 
                                    '<p class="text-xs text-gray-600 text-center mt-2 italic">Click "Apply" button on the opportunity page</p>' : ''}
                                
                                <div class="text-xs text-gray-500 text-center ${opp.source_platform === 'artwork_archive' || opp.source_platform === 'showsubmit' ? 'mt-3' : ''}">
                                    Source: ${opp.source_platform || 'Unknown'}<br>
                                    Last updated: ${opp.updated_at ? new Date(opp.updated_at).toLocaleDateString() : 'Unknown'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const feeFilter = document.getElementById('feeFilter').value;
            const platformFilter = document.getElementById('platformFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Filter
            filteredOpportunities = opportunities.filter(opp => {
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        opp.title,
                        opp.organization,
                        opp.location_city,
                        opp.location_state,
                        opp.description
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                // Platform filter
                if (platformFilter && opp.source_platform !== platformFilter) return false;
                
                // Type filter
                if (typeFilter && opp.opportunity_type !== typeFilter) return false;
                
                // Fee filter
                if (feeFilter) {
                    const fee = parseFloat(opp.application_fee) || 0;
                    switch(feeFilter) {
                        case 'free':
                            if (fee > 0) return false;
                            break;
                        case 'under50':
                            if (fee >= 50) return false;
                            break;
                        case 'under100':
                            if (fee >= 100) return false;
                            break;
                        case 'over100':
                            if (fee < 100) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            // Sort
            filteredOpportunities.sort((a, b) => {
                switch(sortBy) {
                    case 'deadline':
                        return (new Date(a.deadline) || new Date('2099-12-31')) - (new Date(b.deadline) || new Date('2099-12-31'));
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'fee_low':
                        return (parseFloat(a.application_fee) || 0) - (parseFloat(b.application_fee) || 0);
                    case 'fee_high':
                        return (parseFloat(b.application_fee) || 0) - (parseFloat(a.application_fee) || 0);
                    default:
                        return 0;
                }
            });
            
            updateStats();
            renderOpportunities();
        }

        function filterDeadline(period) {
            const now = new Date();
            let endDate = new Date();
            
            if (period === 'week') {
                endDate.setDate(endDate.getDate() + 7);
            } else if (period === 'month') {
                endDate.setMonth(endDate.getMonth() + 1);
            }
            
            filteredOpportunities = opportunities.filter(opp => {
                if (!opp.deadline) return false;
                const deadline = new Date(opp.deadline);
                return deadline >= now && deadline <= endDate;
            });
            
            updateStats();
            renderOpportunities();
        }

        function filterLocation(type) {
            if (type === 'online') {
                filteredOpportunities = opportunities.filter(opp => 
                    opp.location_city?.toLowerCase().includes('online') ||
                    opp.location_state?.toLowerCase().includes('online') ||
                    opp.description?.toLowerCase().includes('online')
                );
            }
            
            updateStats();
            renderOpportunities();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('feeFilter').value = '';
            document.getElementById('platformFilter').value = '';
            document.getElementById('sortBy').value = 'deadline';
            
            filteredOpportunities = [...opportunities];
            updateStats();
            renderOpportunities();
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('opportunitiesGrid').innerHTML = '';
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showEmpty() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('opportunitiesGrid').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
        }
    </script>
</body>
</html>